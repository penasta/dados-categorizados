---
title: "Trabalho de Dados Categorizados 1/2024"
subtitle: "Profa. Maria Tereza Leão Costa"
author: 
  - name: Bruno Gondim Toledo (15/0167636)
  - name: Rafael de Acypreste (20/0060023)
date: last-modified
date-format: "DD/MM/YYYY"
format: 
  pdf:
    toc: true  # Enable Table of Contents for PDF
    toc-title: "Sumário"
    number-sections: true  # Enable section numbering
    fig-pos: 'H'
execute:
  warning: false
  echo: false
crossref:
  fig-prefix: Figura   # (default is "Figure")
  tbl-prefix: Tabela 
  fig-title: Figura
  tbl-title: Tabela
editor: source
editor_options: 
  chunk_output_type: console
---




```{r}
#| results: hide
#| output: false
#| cache: true


source("trabalho/trabalho.R")

options(digits = 5)

```

```{r}
pacman::p_load(
 gtsummary,   # Gera tabelas organizadas por categoria
  gt,          # Gera tabelas em formato latex
  labelled,   # Adiciona labels às variáveis
  sjPlot,     # Gera gráficos para os modelos de regressão
  scales,     # Adiciona escalas aos gráficos
  kableExtra, # Adiciona formatação às tabelas
  dplyr,      # Manipulação de dados
  tidyr,      # Manipulação de dados
  ggplot2     # Gera gráficos
)

```

\newpage

# Introdução

Ao se constatar que um paciente desenvolveu câncer, é fundamental, para se decidir qual tratamento utilizar, saber se o câncer já se espalhou para os linfonodos próximos. Um estudo foi realizado com o objetivo de medir a capacidade de predição para o envolvimento nodal em câncer de próstata de várias variáveis pré-operatórias cuja coleta é menos invasiva que uma cirurgia.

• Numa primeira etapa, desejava-se avaliar especificamente o efeito do nível de
fosfatase ácida na predição para envolvimento nodal; e

• Na segunda etapa do estudo se considerou além desta variável as outras variáveis
pré-operatórias. 

Com isso, o presente estudo objetiva analisar os dados coletados e verificar a capacidade de predição para o envolvimento nodal em câncer de próstata.



## Análise exploratória

Os dados avaliados consistem no acompanhamento clínico de 146 pacientes com câncer de próstata. Um resumo das variáveis pode ser visto na @tbl-dados.  


```{r dados}
#| label: tbl-dados
#| tbl-cap: Resumo dos dados.

var_label(dados) <- list(
  resultado_radiografia = "Resultado da Radiografia",
  estagio_tumor         = "Estágio do Tumor",
  nivel_fosfatase_acida = "Nível da Fosfatase Ácida",
  envolvimento_nodal    = "Envolvimento Nodal (x100)"
)


dados |> 
  tbl_summary() |> 
  modify_header(label ~ "**Variável**") |>
  as_gt() |>
  as_latex()
```


A variável resposta de interesse é de Envolvimento Nodal. Nesse sentido, a @tbl-envolvimento-nodal apresenta a distribuição das variáveis coletadas por pessoas que apresentaram ou não o envolvimento.


```{r}
#| label: tbl-envolvimento-nodal
#| tbl-cap: Distribuição das variáveis por envolvimento nodal.

dados |> 
  tbl_summary(by = envolvimento_nodal) |> 
  modify_header(label ~ "**Envolvimento nodal**") |>
  as_gt() |>
  as_latex()


```

O que se pode perceber é que as variáveis relativas ao resultado da tomografia, do estágio do tumor e do nível da Fosfatase ácida são mais elevados entre os pacientes que apresentaram envolvimento nodal. Entretanto, é preciso usar métodos estatísticos adequados para verificar se essas diferenças são significativas.

A relação entre o Envolvimento Nodal e o nível da Fosfatase Ácida pode ser vista na @fig-fosfatase-acida-envolvimento-nodal. Por ela, também é reforçada a ideia de que o nível da Fosfatase Ácida é mais elevado entre os pacientes que apresentaram envolvimento nodal.

```{r}
#| label: fig-fosfatase-acida-envolvimento-nodal
#| fig-cap: Relação entre o nível da Fosfatase Ácida e o Envolvimento Nodal.
#| fig-width: 3


  ## Variáveis auxiliares
theme_blank <- theme_bw() + theme(panel.grid.minor = element_blank(),
                                  panel.grid.major = element_blank())

dados |>
  ggplot(aes(x = envolvimento_nodal, y = nivel_fosfatase_acida)) +
  geom_boxplot(fill = "skyblue") +
  labs(title = "Relação entre o nível da Fosfatase Ácida e o Envolvimento
Nodal",
       x = "Envolvimento Nodal",
       y = "Nível da Fosfatase Ácida (x100)") +
  theme_blank
```



# Metodologia

## Análise de Regressão Logística

Para a resposta às duas perguntas do problema, pode-se utilizar o modelo de regressão logística. Como a variável resposta, Envolvimento Nodal, é uma variável binária, pode-se codificá-la para que assuma o valor 1 se o paciente apresentou envolvimento nodal e 0 caso contrário.

Numa primeira etapa, para se avaliar apenas a capacidade do nível de fosfatase ácida em predizer o envolvimento nodal, pode-se ajustar o modelo de regressão logística com a variável nível de fosfatase ácida como preditora. O modelo utilizado é dado pela equação \eqref{eq-regressao-logistica}.
\begin{equation}
\label{eq-regressao-logistica}
\log\left(\frac{\pi_i}{1-\pi_i}\right) = \beta_0 + \beta_1 X_{3i}
\end{equation} em que $\pi_i$ é a probabilidade de um paciente $i$ apresentar envolvimento nodal, $X_{3i}$ é o nível de fosfatase ácida do paciente $i$ e $\beta_0$ e $\beta_1$ são os coeficientes do modelo. A função de ligação logito é dada por $\log\left(\frac{\pi_i}{1-\pi_i}\right)$, que tem como resposta o modelo linear visto na equação.

De maneira específica, o coeficiente $e^{\beta_1}$ indica o quanto a razão de chances de um paciente apresentar envolvimento nodal aumenta para cada unidade de aumento no nível de fosfatase ácida. 

Por mim, o modelo saturado inclui todas as variáveis disponíveis de Estágio do Tumor, Resultado da Radiografia e Nível da Fosfatase Ácida. Nesse caso, o modelo é dado pela equação \eqref{eq-regressao-logistica-saturado}.

\begin{equation}
\label{eq-regressao-logistica-saturado}
\log\left(\frac{\pi_i}{1-\pi_i}\right) = \beta_0 + \beta_1 X_{1i} + \beta_2 X_{2i} + \beta_3 X_{3i}
\end{equation} em que $X_{1i}$, $X_{2i}$ e $X_{3i}$ são as variáveis Nível da Fosfatase Ácida, Resultado da Radiografia e Estágio do Tumor, respectivamente.


# Resultados

## Modelo apenas com intercepto

Como estratégia inicial, pode-se avaliar o modelo com uma média única pra todos os níveis de Fosfatase Ácida. Nesse caso, o modelo é dado pela equação \eqref{eq-regressao-logistica-intercepto}.

\begin{equation}
\label{eq-regressao-logistica-intercepto}
\log\left(\frac{\pi_i}{1-\pi_i}\right) = \beta_0
\end{equation}

O modelo com esse ajuste pode ser avaliado na @fig-modelo-intercepto.


```{r}
#| label: fig-modelo-intercepto
#| fig-cap: Modelo de regressão logística com intercepto. Os pontos foram ligeiramente agitados para facilitar a visualização.
#| fig-height: 3

# Calculate the predicted response from the model
predicted_response <- predict(fit0,
                              type = "response")

# Create the base plot with jittered points
df |> 
ggplot(aes(x = nivel_fosfatase_acida,
               y = envolvimento_nodal)) +
  geom_jitter(aes(color = "Data Points"), # Add jittered points
              height = 0.01,
              color = "black",
              alpha = 0.5,
              shape = 16) +
  # Add a horizontal line for the model prediction
  geom_hline(
    aes(yintercept = predicted_response),
    linetype = "solid",
    color = "red",
    linewidth = 1
  ) +
  theme_blank +
  theme(legend.position = "none")+ 
  labs(x = "Nível de Fosfatase Ácida  (x100)",
       y = "Envolvimento Nodal", 
       title = "Previsões do modelo apenas com intercepto") +
  scale_y_continuous(labels = percent_format(accuracy = 1)) # Transform y-axis to percentages




```

As estatísticas de avaliação do modelo podem ser vistas na @tbl-modelo-intercepto.

```{r}
#| label: tbl-modelo-intercepto
#| tbl-cap: Estatísticas do modelo de regressão logística com intercepto.

digits <- 1


medidas0 |>
  kbl(booktabs = TRUE,
      escape   = FALSE,
      digits   = digits) |>
  kable_styling(bootstrap_options = "striped", latex_options     = "HOLD_position")
```



## Modelo acrescido do Nível de Fosfatase Ácida como variável preditora

O modelo para o nível de Fosfatase Ácida como variável preditora é dado pela equação \eqref{eq-regressao-logistica}. As probabilidades previstas estão apresentadas na @fig-modelo-com-fosfatase-acida.


```{r}
#| label: fig-modelo-com-fosfatase-acida
#| fig-cap: Modelo de regressão logística com o nível de Fosfatase Ácida como variável preditora. Os pontos foram ligeiramente agitados para facilitar a visualização.
#| fig-height: 3

plot_model(fit1, type  = "pred", terms = "nivel_fosfatase_acida [all]") +
  geom_jitter(
    # Add jittered points
    data = df,
    aes(x = nivel_fosfatase_acida,
        y = envolvimento_nodal),
    height = 0.01,
    color = "black",
    alpha = 0.5,
    shape = 16
  ) +
  theme_blank +
  labs(title = "Probabilidades previstas de evolvimento nodal",
       x     = "Nível de Fosfatase Ácida  (x100)",
       y     = "Envolvimento Nodal") +
  scale_y_continuous(limit = c(0, 1),
                     breaks = c(0, .25, .5, .75, 1),
                     labels = percent_format(accuracy = 1)) # Transform y-axis to percentages
```


As estatísticas do modelo quando é acrescido o nível de Fosfatase Ácida como variável preditora estão apresentadas na @tbl-modelo-com-fosfatase-acida.

```{r}
#| label: tbl-modelo-com-fosfatase-acida
#| tbl-cap: Estatísticas do modelo de regressão logística com o nível de Fosfatase Ácida como variável preditora.

digits <- 3

coef1 |> 
  as_tibble() |> 
  mutate(Variável = rownames(coef1)) |>
  select(Variável, everything()) |>
  kbl(booktabs = TRUE,
      escape   = TRUE,
      digits   = digits) |>
  kable_styling(bootstrap_options = "striped",
                latex_options     = "HOLD_position")
```


O teste de Hosmer-Lemeshow pode ser utilizado para avaliar a qualidade do ajuste. Para o modelo da apresentado na @tbl-modelo-com-fosfatase-acida, a estatística $\chi^2$ do teste de Hosmer-Lemeshow é de `r round(hoslem_fit1[["statistic"]], 2)` com um p-valor de `r round(hoslem_fit1[["p.value"]], 5)`. O teste sugere que o modelo ajustado não é adequado para os dados.

Por fim, as estatísticas do modelo que inclui a variável "Nível de Fosfatase Ácida" como preditora estão apresentadas na @tbl-medidas-modelo-fosfatase-acida.

```{r}
#| label: tbl-medidas-modelo-fosfatase-acida
#| tbl-cap: Estatísticas de qualidade do modelo de regressão logística com o nível de Fosfatase Ácida como variável preditora.
#| tbl-pos: H

medidas1 |>
  kbl(booktabs = TRUE,
      escape   = FALSE,
      digits   = digits) |>
  kable_styling(bootstrap_options = "striped",
                latex_options     = "HOLD_position")
```



### Comparação dos modelos

Uma forma de avaliar o modelo com a variável explicativa "Nível de Fosfatase Ácida" é comparar com o modelo apenas com intercepto. A @tbl-comparacao-modelos apresenta as estatísticas de comparação entre os modelos.

```{r}
#| label: tbl-comparacao-modelos
#| tbl-cap: Estatísticas de comparação entre os modelos de regressão logística com a variável "Nível de Fosfatase Ácida" e apenas com intercepto.

testes1 |> 
  as_tibble() |> 
  mutate(Teste = rownames(testes1)) |>
  select(Teste, everything()) |>
  kbl(booktabs = TRUE,
      escape   = TRUE,
      digits   = digits) |>
  kable_styling(bootstrap_options = "striped",
                latex_options     = "HOLD_position")
```

Portanto, percebe-se que que nenhum dos 3 testes rejeitaram a hipótese nula a 5%. Isto é, o modelo não é significativamente melhor que o modelo que contém apenas o intercepto.


## Modelo Saturado

As demais informações disponíveis podem auxiliar um melhor ajuste do modelo. Nesse caso, o modelo saturado é ajustado. As estatísticas do modelo saturado estão apresentadas na @tbl-modelo-saturado.

```{r}
#| label: tbl-modelo-saturado
#| tbl-cap: Estatísticas do modelo de regressão logística saturado.

digits <- 4

coef2 |> 
  as_tibble() |> 
  mutate(Variável = rownames(coef2)) |>
  select(Variável, everything()) |>
  kbl(booktabs = TRUE,
      escape   = TRUE,
      digits   = digits) |>
  kable_styling(bootstrap_options = "striped",
                latex_options     = "HOLD_position")
```

O teste de Hosmer-Lemeshow para o modelo saturado é de `r round(hoslem_fit2[["statistic"]], 2)` com um p-valor de `r round(hoslem_fit2[["p.value"]], 5)`. O teste sugere que o modelo saturado ajustado não é adequado para os dados.

Pode-se inspecionar as previsões do modelo saturado na @fig-modelo-saturado.


```{r}
#| label: fig-modelo-saturado
#| fig-cap: Modelo de regressão logística saturado. Os pontos foram ligeiramente agitados para facilitar a visualização.
#| fig-height: 4.5

plot_model(fit2,
           type  = "pred",
           terms = c("nivel_fosfatase_acida [all]",
                     "resultado_radiografia",
                     "estagio_tumor")) +
  geom_jitter(
    # Add jittered points
    data = mutate(df, group_col = factor(estagio_tumor)), # Coluna da facet devia se chamar group_col
    aes(x = nivel_fosfatase_acida,
        y = envolvimento_nodal),
    height = 0.01,
    color = "black",
    size = 1.5,
    alpha = 0.5,
    shape = 16
  ) +
  theme_blank +
  theme(legend.position = "bottom") +
  labs(title = "Probabilidades previstas de evolvimento nodal de acordo
com as variáveis do modelo saturado",
       x     = "Nível de Fosfatase Ácida  (x100)",
       y     = "Envolvimento Nodal",
       color = "Resultado da Radiografia") +
  scale_y_continuous(limit = c(0, 1),
                     breaks = c(0, .25, .5, .75, 1),
                     labels = percent_format(accuracy = 1)) # Transform y-axis to percentages
```

As estatísticas de qualidade do modelo saturado estão apresentadas na @tbl-medidas-modelo-saturado.

```{r}
#| label: tbl-medidas-modelo-saturado
#| tbl-cap: Estatísticas de qualidade do modelo de regressão logística saturado.

medidas2 |>
  kbl(booktabs = TRUE,
      escape   = FALSE,
      digits   = digits) |>
  kable_styling(bootstrap_options = "striped",
                latex_options     = "HOLD_position")
```


### Comparação dos modelos

A @tbl-comparacao-modelos-saturado apresenta as estatísticas de comparação entre o modelo saturado e o modelo com intercepto. \textcolor{red}{e com a variável "Nível de Fosfatase Ácida" (SE DER)} 

```{r}
#| label: tbl-comparacao-modelos-saturado
#| tbl-cap: Estatísticas de comparação entre os modelos de regressão logística saturado e com intercepto.



testes2 |> 
  as_tibble() |> 
  mutate(Teste = rownames(testes2)) |>
  select(Teste, everything()) |>
  kbl(booktabs = TRUE,
      escape   = TRUE) |>
  kable_styling(bootstrap_options = "striped",
                latex_options     = "HOLD_position")
```



## Demais modelos possíveis

Também é possível avaliar as demais combinações de modelos, cujas estatísticas de qualidade de ajuste estão na @tbl-modelos-possiveis.

```{r}
#| label: tbl-modelos-possiveis
#| tbl-cap: Estatísticas de qualidade dos modelos de regressão logística com as variáveis preditoras possíveis.

digits <- 2

medidas |>
  kbl(booktabs = TRUE,
      escape   = TRUE,
      digits   = digits) |>
  kable_styling(bootstrap_options = "striped",
                latex_options     = "HOLD_position")
```

O método *stepwise* pode ser utilizado para selecionar o melhor modelo. Nesse caso, considerando tal método e os dados apresentados de qualidade de ajustes dos modelos, a escolha indicada foi exatamente a do modelo completo.


\textcolor{red}{Pode-se comparar o modelo completo com o modelo de segunda melhor *deviance*}

## Análise a partir do modelo escolhido


Para avaliar a qualidade do modelo, pode-se utilizar a curva ROC. A @fig-curva-roc apresenta a curva ROC do modelo escolhido.


```{r}
#| label: fig-curva-roc
#| fig-cap: Curva ROC do modelo de regressão logística escolhido.
#| fig-height: 4
#| fig-width: 4

# Plotting the ROC curve with ggplot2
roc_data |> 
ggplot(aes(x = Spec_comp,
           y = Sensit)) +
  geom_path() + # Draw the ROC curve
  geom_abline(linetype = "dashed") + # Add a 45 degree line
  labs(title = "Curva ROC - Modelo completo",
       x = "1 - Especificidade (Taxa de Falso positivo)",
       y = "Sensitificade (Taxa de positivo verdadeiro)") +
  theme_blank
```


## Aplicação do modelo escolhido ao conjunto de teste

O modelo escolhido é aplicado ao conjunto de teste. A @tbl-matriz-confusao apresenta a matriz de confusão do modelo aplicado ao conjunto de teste. O valor de corte definido foi de 0.5.

```{r}
#| label: tbl-matriz-confusao
#| tbl-cap: Matriz de confusão do modelo de regressão logística aplicado ao conjunto de teste.

matriz_conf_alternativa |> 
  kbl(booktabs = TRUE,
      escape   = TRUE) |>
  kable_styling(bootstrap_options = "striped",
                latex_options     = "HOLD_position")

```


Para esse caso específico, o modelo teve `r round(acertos * 100, 2)`% de acertos, o que confere um caráter interessante para previsão dos resultados.

# Conclusão



